<!doctype html>
<html class="no-js" lang="en" data-content_root="./">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="index" title="Index" href="genindex.html" /><link rel="search" title="Search" href="search.html" /><link rel="next" title="Tasks" href="tasks.html" /><link rel="prev" title="Design overview" href="design.html" />

    <link rel="shortcut icon" href="_static/redun-no-text.svg"/><!-- Generated with Sphinx 8.0.2 and Furo 2024.08.06 -->
        <title>Values - redun documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="_static/styles/furo.css?v=354aac6f" />
    <link rel="stylesheet" type="text/css" href="_static/styles/furo-extensions.css?v=302659d7" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="index.html"><div class="brand">redun  documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="index.html">
  
  <div class="sidebar-logo-container">
    <img class="sidebar-logo" src="_static/redun.svg" alt="Logo"/>
  </div>
  
  <span class="sidebar-brand-text">redun  documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <p class="caption" role="heading"><span class="caption-text">User guide</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="design.html">Design overview</a></li>
<li class="toctree-l1 current current-page"><a class="current reference internal" href="#">Values</a></li>
<li class="toctree-l1"><a class="reference internal" href="tasks.html">Tasks</a></li>
<li class="toctree-l1"><a class="reference internal" href="executors.html">Executors</a></li>
<li class="toctree-l1"><a class="reference internal" href="scheduler.html">Scheduling redun workflows</a></li>
<li class="toctree-l1"><a class="reference internal" href="config.html">Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="db.html">Backend and database</a></li>
<li class="toctree-l1"><a class="reference internal" href="tags.html">Tags</a></li>
<li class="toctree-l1"><a class="reference internal" href="spark.html">Spark</a></li>
<li class="toctree-l1"><a class="reference internal" href="typing.html">Type checking</a></li>
<li class="toctree-l1"><a class="reference internal" href="console.html">Console (TUI)</a></li>
<li class="toctree-l1"><a class="reference internal" href="context.html">Context</a></li>
<li class="toctree-l1"><a class="reference internal" href="visualization.html">Visualization</a></li>
<li class="toctree-l1"><a class="reference internal" href="FAQ.html">FAQ</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Development</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="developing.html">Developer guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="CHANGELOG.html">Changelog</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Implementation notes</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="implementation/hashing.html">Content addressable hashing summary</a></li>
<li class="toctree-l1"><a class="reference internal" href="implementation/graph_reduction_caching.html">Graph reduction caching</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1 has-children"><a class="reference internal" href="redun/modules.html">API docs</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle navigation of API docs</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="redun/redun.html">redun package</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle navigation of redun package</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3 has-children"><a class="reference internal" href="redun/redun.backends.html">redun.backends package</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><div class="visually-hidden">Toggle navigation of redun.backends package</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="redun/redun.backends.db.html">redun.backends.db package</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="redun/redun.console.html">redun.console package</a></li>
<li class="toctree-l3"><a class="reference internal" href="redun/redun.executors.html">redun.executors package</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/insitro/redun">GitHub repository</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="view-this-page">
  <a class="muted-link" href="_sources/values.md.txt" title="View this page">
    <svg><use href="#svg-eye"></use></svg>
    <span class="visually-hidden">View this page</span>
  </a>
</div>
<div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <section id="values">
<h1>Values<a class="headerlink" href="#values" title="Link to this heading">¶</a></h1>
<p>Values is the general term redun uses to refer to task arguments and results. Below, we describe
some of the special treatments redun uses to enable expressive value dataflow.</p>
<section id="hashing-and-equality">
<h2>Hashing and equality<a class="headerlink" href="#hashing-and-equality" title="Link to this heading">¶</a></h2>
<p>All values in redun must be hashable. Hashes are used to define equality of values, without any
fallback to deep equality checking.</p>
<p>An important consequence is that redun ignores the difference between whether two entities
actually references to the same underlying object, or merely hash identically. For example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyObject</span><span class="p">:</span>
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">MyObject</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">MyObject</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<p>Since <code class="docutils literal notranslate"><span class="pre">x</span></code> and <code class="docutils literal notranslate"><span class="pre">y</span></code> hash identically, redun cannot distinguish between them.</p>
<p>Therefore, hashes provide a unique mechanism for indexing objects in the backend.</p>
</section>
<section id="serialization">
<h2>Serialization<a class="headerlink" href="#serialization" title="Link to this heading">¶</a></h2>
<p>Redun primarily serializes <code class="docutils literal notranslate"><span class="pre">Value</span></code>s with <code class="docutils literal notranslate"><span class="pre">pickle</span></code> since it is native to python and provides powerful tools for
serializing complex and nested Python objects. Users may customize this as usual, with
<code class="docutils literal notranslate"><span class="pre">__getstate__</span></code> and <code class="docutils literal notranslate"><span class="pre">__setstate__</span></code>.</p>
</section>
<section id="validity">
<h2>Validity<a class="headerlink" href="#validity" title="Link to this heading">¶</a></h2>
<p>In addition to handling ordinary values, i.e., data or objects represented in memory, complex
workflows often require reasoning about state that may be complex or external, such as
a database or filesystem. Redun accomplishes reasoning over this state by converting it into
value-like semantics, after which, redun can proceed without differentiating between values
and state. Specifically, the <code class="docutils literal notranslate"><span class="pre">Value</span></code> class provides that abstraction.</p>
<p>After deserializing a regular data object, we could typically assume that the serialization
was successful and proceed to use the resulting object. However, state management requires
that after deserialization, we offer another lifecycle hook, <code class="docutils literal notranslate"><span class="pre">is_valid</span></code>, during which the
object can identify that the deserialized state no longer matches reality, and hence may not
be relied upon.</p>
<p>The simplest example of validity is a <code class="docutils literal notranslate"><span class="pre">Value</span></code> representing a file on a shared filesystem,
where we serialize both the path to the file (as a string) and hash of the file contents. When we
retrieve a cache value and deserialize the object, we can recheck the hash of the file. If the
file hash does not match, then the object can declare that its state assertion is not valid,
and that we should reassert it (i.e., re-run the task to rewrite the file with the intended
contents).</p>
<p>See (File reactivity)[design.md#File-reactivity] for more exposition on the file case.</p>
</section>
<section id="extending-standard-types-with-proxyvalues">
<h2>Extending standard types with <code class="docutils literal notranslate"><span class="pre">ProxyValue</span></code>s<a class="headerlink" href="#extending-standard-types-with-proxyvalues" title="Link to this heading">¶</a></h2>
<p>Many task have inputs or outputs that are not redun <code class="docutils literal notranslate"><span class="pre">Value</span></code> types, either because they are
builtins like <code class="docutils literal notranslate"><span class="pre">str</span></code> or <code class="docutils literal notranslate"><span class="pre">int</span></code>, or are other types, such as <code class="docutils literal notranslate"><span class="pre">np.array</span></code>. When the redun scheduler
works with these, it wraps them in <code class="docutils literal notranslate"><span class="pre">ProxyValue</span></code>, but then unwraps them before presenting them to
user code. The default implementation derives a hash function from the pickle serialization
of the object, which is a good, general purpose choice.</p>
<p>The result is that for most basic data types, users don’t need to do anything to teach redun
to work with their types. As a result, this code works fine, even though redun doesn’t know
anything about <code class="docutils literal notranslate"><span class="pre">numpy</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="nd">@task</span>
<span class="k">def</span> <span class="nf">task</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>
</pre></div>
</div>
<p>If this default behavior is not desirable, users can implement either <code class="docutils literal notranslate"><span class="pre">Value</span></code> or <code class="docutils literal notranslate"><span class="pre">ProxyValue</span></code> types
to customize the behavior. These types also provide hooks to allow the CLI to parse them,
which the <code class="docutils literal notranslate"><span class="pre">redun</span> <span class="pre">run</span></code> command relies on.</p>
</section>
<section id="handles-for-ephemeral-and-stateful-values">
<h2>Handles for ephemeral and stateful values<a class="headerlink" href="#handles-for-ephemeral-and-stateful-values" title="Link to this heading">¶</a></h2>
<p>We’ll introduce the features of Handles in several steps. The first feature that Handles provide is control over the data used for serialization and a mechanism for recreating ephemeral state after deserialization. Let’s say we wanted to pass a database connection between tasks in a safe way. We could use a Handle class to do the following:</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">redun</span> <span class="kn">import</span> <span class="n">task</span><span class="p">,</span> <span class="n">Handle</span>

<span class="k">class</span> <span class="nc">DbHandle</span><span class="p">(</span><span class="n">Handle</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">db_file</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db_file</span> <span class="o">=</span> <span class="n">db_file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">instance</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">db_file</span><span class="p">)</span>

<span class="nd">@task</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">extract</span><span class="p">(</span><span class="n">conn</span><span class="p">):</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;select * from my_table&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchmany</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">data</span>

<span class="nd">@task</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="c1"># result = transform data in some way...</span>
    <span class="k">return</span> <span class="n">result</span>

<span class="nd">@task</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">executemany</span><span class="p">(</span><span class="s1">&#39;insert into another_table values(?, ?, ?)&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">conn</span>

<span class="nd">@task</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># Two databases we want to move data between</span>
    <span class="n">src_conn</span> <span class="o">=</span> <span class="n">DbHandle</span><span class="p">(</span><span class="s1">&#39;src_conn&#39;</span><span class="p">,</span> <span class="s1">&#39;src_data.db&#39;</span><span class="p">)</span>
    <span class="n">dest_conn</span> <span class="o">=</span> <span class="n">DbHandle</span><span class="p">(</span><span class="s1">&#39;dest_conn&#39;</span><span class="p">,</span> <span class="s1">&#39;dest_data.db&#39;</span><span class="p">)</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">extract</span><span class="p">(</span><span class="n">src_conn</span><span class="p">)</span>
    <span class="n">data2</span> <span class="o">=</span> <span class="n">transform</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">dest_conn2</span> <span class="o">=</span> <span class="n">load</span><span class="p">(</span><span class="n">dest_conn</span><span class="p">,</span> <span class="n">data2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dest_conn2</span>
</pre></div>
</div>
<p>First, we use the <code class="docutils literal notranslate"><span class="pre">DbHandle</span></code> class to wrap a sqlite database connection. When Handles are serialized, only the arguments to their constructor are serialized. Therefore, you can define as much internal state as you wish for a Handle and it will not get caught up in the cache. redun’s default serialization is Python’s pickle framework. pickle uses the <code class="docutils literal notranslate"><span class="pre">__new__()</span></code> constructor and <code class="docutils literal notranslate"><span class="pre">__setstate__</span></code> (or <code class="docutils literal notranslate"><span class="pre">__dict__</span></code>) to directly set the state of an object, thus avoiding calling the <code class="docutils literal notranslate"><span class="pre">__init__</span></code> initializer. Handles modify this behavior in order to execute <code class="docutils literal notranslate"><span class="pre">__init__</span></code> even when deserializing. Therefore, we can use the constructor to reestablish ephemeral state such as the database connection.</p>
<p>Since Handles are often used to wrap another object, such as a connection, Handles provide a convenient mechanism for reducing boiler plate code. If a Handle defines a <code class="docutils literal notranslate"><span class="pre">self.instance</span></code> attribute, all attribute access to the Handle is automatically proxied to the <code class="docutils literal notranslate"><span class="pre">self.instance</span></code>. Above the <code class="docutils literal notranslate"><span class="pre">conn.execute()</span></code> and <code class="docutils literal notranslate"><span class="pre">conn.executemany()</span></code> calls make use of the attribute proxy.</p>
<section id="state-tracking">
<h3>State tracking<a class="headerlink" href="#state-tracking" title="Link to this heading">¶</a></h3>
<p>Now let’s take a closer look at the <code class="docutils literal notranslate"><span class="pre">load()</span></code> task. It uses a handle, <code class="docutils literal notranslate"><span class="pre">dest_conn</span></code>, as an input and output in order to perform a write. Ideally, we would like to represent that <code class="docutils literal notranslate"><span class="pre">dest_conn</span></code> is updated by the <code class="docutils literal notranslate"><span class="pre">load</span></code> task so that we can correctly determine which tasks need to be re-executed when input data or code changes.</p>
<p>As we stated before, hashing an entire database just to represent the database state is often not feasible, either because there is too much data to rehash frequently, or the database state contains too much ancillary data to hash consistently. As an alternative to hashing the whole database, we could just hash the sequence of operations (i.e. Tasks) we have applied to database Handle. This is the strategy redun takes.</p>
<p>Specifically, as a handle passes into or out of a Task, the redun scheduler duplicates the Handle and incorporates into its hash information specific to the task call, such as the hash of the corresponding call node. Therefore, in the example above, if we look at these specific lines:</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="nd">@task</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="n">conn_i</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">executemany</span><span class="p">(</span><span class="s1">&#39;insert into another_table values(?, ?, ?)&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">conn_i</span>

<span class="nd">@task</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># SNIP...</span>
    <span class="n">dest_conn2</span> <span class="o">=</span> <span class="n">load</span><span class="p">(</span><span class="n">dest_conn</span><span class="p">,</span> <span class="n">data2</span><span class="p">)</span>
    <span class="c1"># SNIP ...</span>
</pre></div>
</div>
<p>the handles <code class="docutils literal notranslate"><span class="pre">dest_conn</span></code>, <code class="docutils literal notranslate"><span class="pre">conn_i</span></code>, and <code class="docutils literal notranslate"><span class="pre">dest_conn2</span></code> are all distinct and have their own hashes. redun also records the lineage of such handles into a Handle Graph which represents the state transitions the handle has gone through:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dest_conn</span><span class="o">*</span> <span class="o">--&gt;</span> <span class="n">conn_i</span><span class="o">*</span> <span class="o">--&gt;</span> <span class="n">dest_conn2</span><span class="o">*</span>
</pre></div>
</div>
<p>redun also records whether each handle state is currently valid or not, which we indicate above using <code class="docutils literal notranslate"><span class="pre">*</span></code> for valid handles. When re-executing a workflow, if a previously cached handle state is still valid we can safely fast forward through the corresponding task.</p>
<p>Now, let’s consider what happens if we added an additional load step and re-executed this workflow:</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="nd">@task</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="n">conn_i</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="c1"># Write data into conn_i...</span>
    <span class="k">return</span> <span class="n">conn_i</span>

<span class="nd">@task</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">load2</span><span class="p">(</span><span class="n">conn_ii</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="c1"># Write date into conn_ii...</span>
    <span class="k">return</span> <span class="n">conn_ii</span>

<span class="nd">@task</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># Two databases we want to move data between</span>
    <span class="n">src_conn</span> <span class="o">=</span> <span class="n">DbHandle</span><span class="p">(</span><span class="s1">&#39;src_conn&#39;</span><span class="p">,</span> <span class="s1">&#39;src_data.db&#39;</span><span class="p">)</span>
    <span class="n">dest_conn</span> <span class="o">=</span> <span class="n">DbHandle</span><span class="p">(</span><span class="s1">&#39;dest_conn&#39;</span><span class="p">,</span> <span class="s1">&#39;dest_data.db&#39;</span><span class="p">)</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">extract</span><span class="p">(</span><span class="n">src_conn</span><span class="p">)</span>
    <span class="n">data2</span> <span class="o">=</span> <span class="n">transform</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">data3</span> <span class="o">=</span> <span class="n">transform2</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">dest_conn2</span> <span class="o">=</span> <span class="n">load</span><span class="p">(</span><span class="n">dest_conn</span><span class="p">,</span> <span class="n">data2</span><span class="p">)</span>
    <span class="n">dest_conn3</span> <span class="o">=</span> <span class="n">load2</span><span class="p">(</span><span class="n">dest_conn2</span><span class="p">,</span> <span class="n">data3</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dest_conn3</span>
</pre></div>
</div>
<p>redun would notice that it can forward through <code class="docutils literal notranslate"><span class="pre">extract</span></code>, <code class="docutils literal notranslate"><span class="pre">transform</span></code>, and <code class="docutils literal notranslate"><span class="pre">load</span></code>, and would only execute <code class="docutils literal notranslate"><span class="pre">transform2</span></code>, and <code class="docutils literal notranslate"><span class="pre">load2</span></code>. The Handle Graph would be updated with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dest_conn</span><span class="o">*</span> <span class="o">--&gt;</span> <span class="n">conn_i</span><span class="o">*</span> <span class="o">--&gt;</span> <span class="n">dest_conn2</span><span class="o">*</span> <span class="o">--&gt;</span> <span class="n">conn_ii</span><span class="o">*</span> <span class="o">--&gt;</span> <span class="n">dest_conn3</span><span class="o">*</span>
</pre></div>
</div>
<p>Now consider what happens if we decided to change the code of task <code class="docutils literal notranslate"><span class="pre">load2()</span></code>. redun would fast forward through much of the workflow but would re-execute <code class="docutils literal notranslate"><span class="pre">load2()</span></code>. In doing so it would branch the Handle Graph, since <code class="docutils literal notranslate"><span class="pre">load2()</span></code> would contribute a different call node hash to the <code class="docutils literal notranslate"><span class="pre">dest_conn3</span></code>. Let’s consider this new Handle <code class="docutils literal notranslate"><span class="pre">dest_conn3b</span></code>, and the Handle Graph would be:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dest_conn</span><span class="o">*</span> <span class="o">--&gt;</span> <span class="n">conn_i</span><span class="o">*</span> <span class="o">--&gt;</span> <span class="n">dest_conn2</span><span class="o">*</span> <span class="o">--&gt;</span> <span class="n">conn_ii</span><span class="o">*</span> <span class="o">--&gt;</span> <span class="n">dest_conn3</span>
                                                  \
                                                   \<span class="o">--&gt;</span> <span class="n">dest_conn3b</span><span class="o">*</span>
</pre></div>
</div>
<p>The old handle state <code class="docutils literal notranslate"><span class="pre">dest_conn3</span></code> is marked as invalid. What’s important about this bookkeeping is that if we revert the change to <code class="docutils literal notranslate"><span class="pre">load2()</span></code>, it is not appropriate to just fast revert to dest_conn3. We must re-execute <code class="docutils literal notranslate"><span class="pre">load2()</span></code> again to update the database to be at state <code class="docutils literal notranslate"><span class="pre">dest_conn3</span></code> (instead of <code class="docutils literal notranslate"><span class="pre">dest_conn3b</span></code>).</p>
</section>
<section id="more-advanced-handle-uses">
<h3>More advanced Handle uses<a class="headerlink" href="#more-advanced-handle-uses" title="Link to this heading">¶</a></h3>
<p><em>This is currently explained very briefly</em></p>
<p>Handles can be forked into instances that can be processed in parallel (parallel loading into a database). Forking might also be done to denote that there is no dependency between the tasks and limit the scope of rollbacks (i.e. Handle invalidation).</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">redun</span> <span class="kn">import</span> <span class="n">merge_handles</span>

<span class="c1"># SNIP ...</span>

<span class="nd">@task</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">DbHandle</span><span class="p">(</span><span class="s1">&#39;conn&#39;</span><span class="p">,</span> <span class="s1">&#39;data.db&#39;</span><span class="p">)</span>
    <span class="n">conn2a</span> <span class="o">=</span> <span class="n">load_a</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
    <span class="n">conn2b</span> <span class="o">=</span> <span class="n">load_b</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
    <span class="n">conn3</span> <span class="o">=</span> <span class="n">merge_handles</span><span class="p">([</span><span class="n">conn2a</span><span class="p">,</span> <span class="n">conn2b</span><span class="p">])</span>
    <span class="n">conn4</span> <span class="o">=</span> <span class="n">load_c</span><span class="p">(</span><span class="n">conn3</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">conn4</span>
</pre></div>
</div>
<p>Handles can also be merged to denote that the previous parallel steps must complete before continuing to the next step. The Handle Graph for the above code would be:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">conn</span><span class="o">*</span> <span class="o">--&gt;</span> <span class="n">conn_i</span><span class="o">*</span> <span class="o">---&gt;</span> <span class="n">conn2a</span><span class="o">*</span> <span class="o">----&gt;</span> <span class="n">conn3</span><span class="o">*</span> <span class="o">--&gt;</span> <span class="n">conn_iii</span><span class="o">*</span> <span class="o">--&gt;</span> <span class="n">conn4</span><span class="o">*</span>
    \                            <span class="o">/</span>
     \<span class="o">--&gt;</span> <span class="n">conn_ii</span><span class="o">*</span> <span class="o">--&gt;</span> <span class="n">conn2b</span><span class="o">*</span> <span class="o">-/</span>
</pre></div>
</div>
<p>Using the above Handle Graph, redun can determine that updating the code for <code class="docutils literal notranslate"><span class="pre">load_b()</span></code> should trigger re-execution for <code class="docutils literal notranslate"><span class="pre">load_b()</span></code> and <code class="docutils literal notranslate"><span class="pre">load_c()</span></code>, but not <code class="docutils literal notranslate"><span class="pre">load_a()</span></code>.</p>
</section>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="tasks.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">Tasks</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="design.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">Design overview</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2023, insitro
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">Values</a><ul>
<li><a class="reference internal" href="#hashing-and-equality">Hashing and equality</a></li>
<li><a class="reference internal" href="#serialization">Serialization</a></li>
<li><a class="reference internal" href="#validity">Validity</a></li>
<li><a class="reference internal" href="#extending-standard-types-with-proxyvalues">Extending standard types with <code class="docutils literal notranslate"><span class="pre">ProxyValue</span></code>s</a></li>
<li><a class="reference internal" href="#handles-for-ephemeral-and-stateful-values">Handles for ephemeral and stateful values</a><ul>
<li><a class="reference internal" href="#state-tracking">State tracking</a></li>
<li><a class="reference internal" href="#more-advanced-handle-uses">More advanced Handle uses</a></li>
</ul>
</li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script src="_static/documentation_options.js?v=5929fcd5"></script>
    <script src="_static/doctools.js?v=9a2dae69"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/scripts/furo.js?v=5fa4622c"></script>
    </body>
</html>